## mimamori プロダクト仕様

---
## 1. システム構成

| 要素 | 詳細 | 役割 |
| :--- | :--- | :--- |
| **データ取得部** | **Raspberry Pi (ラズパイ)** | データ収集、前処理、送信制御のコアユニット。低消費電力モデル（例：Raspberry Pi Zero WやPi 3/4）を推奨。 |
| **センサー** | **土壌センサー** (水分量、温度、EC値など) | 土壌データを物理的に計測。アナログセンサーの場合はADC（A/Dコンバーター）が必要。デジタルセンサー（例：I2C/SPI接続）を推奨。 |
| **データ送信・保存部** | **Cloudflare Workers / R2 / KV** | ラズパイからのデータを受け取り、**保存、処理**の基盤。KVまたはR2を用いて時系列データを効率的に保持。 |
| **通信プロトコル** | **HTTPS (REST API)** | データの信頼性とセキュリティを確保しつつ、Cloudflare Workersとの連携を容易にする。 |
| **データ可視化部** | **Grafana** | 保存された時系列データに接続し、**ダッシュボードとしてデータを視覚的に表示**する。Cloudflareのデータストア（例：PostgreSQL on Workers, TimescaleDBなど）と連携を想定。 |
| **通知連携部** | **Slack Webhook / API** | **データ取得・保存の完了**や、**重要なエラー**を即座に通知する。 |

---
## 2. 要件 F1: データの取得（土壌データの収集）

| No. | 仕様項目 | 詳細 | 備考 |
| :--- | :--- | :--- | :--- |
| **F1-1** | **取得対象データ** | **土壌水分量**（パーセンテージまたは相対値）、**土壌温度**（$^\circ \text{C}$）、**外気温**（$^\circ \text{C}$）、**湿度**（$\%$）の4種を必須とする。 | センサーの選定に依存。必要に応じてEC値（電気伝導度）を追加。 |
| **F1-2** | **取得頻度** | **15分間隔**でデータ取得処理を実行。設定ファイル（例：`config.json`）で変更可能とする。 | デフォルトは15分。バッテリー駆動の場合はこの間隔を調整。 |
| **F1-3** | **データ前処理** | ラズパイ側でセンサーの生データを取得後、**校正（キャリブレーション）**処理を実施し、物理量に変換する。異常値（センサーの故障や範囲外の値）を検知し、ログに記録する。 | 異常値は送信データに含めるか（例：`null`）、直前の正常値を使用する（オプション）。 |
| **F1-4** | **時刻情報** | 取得データには、ラズパイのシステム時刻に基づく**UTC時刻**でのタイムスタンプを付与する。 | データの一貫性を保つため、タイムゾーンはUTCに統一。**Grafanaでの時系列表示**に不可欠。 |

---
## 3. 要件 F2: データ送信（センサーデータの送信）

| No. | 仕様項目 | 詳細 | 備考 |
| :--- | :--- | :--- | :--- |
| **F2-1** | **送信形式** | **JSON形式**でデータを構成し、HTTP POSTリクエストのボディとして送信する。 | 軽量で汎用性が高い形式。 |
| **F2-2** | **データ構造** | 以下の主要なキーを持つJSONオブジェクトとする。 | `device_id`は各ラズパイを識別するために必須。**Grafanaで複数デバイスをフィルタリングする**ためのキーとなる。 |
| | | `{"device_id": "rasp_001", "timestamp_utc": "2025-10-02T04:30:00Z", "soil_moisture": 55.2, "soil_temp": 20.5, "air_temp": 22.1, "humidity": 60.5, "status": "OK"}` | |
| **F2-3** | **送信間隔** | **5分間隔**で取得と同時にCloudflareのAPIエンドポイントへ送信。 | 不意に電源断が起きることを考慮。 |
| **F2-4** | **宛先エンドポイント** | Cloudflare Workersで実装された**専用のHTTPSエンドポイント**とする。 | 例: `https://api.mimamori.cloud/v1/data` |
| **F2-5** | **セキュリティ** | 送信リクエストには、APIキーまたはトークンを**HTTPヘッダー**（例：`Authorization`）に含めて認証を行う。SSL/TLS通信（HTTPS）を必須とする。 | Workers側でトークン検証を実施し、不正アクセスを防止。 |
| **F2-6** | **エラー処理** | 送信失敗時（例：ネットワークエラー、サーバーエラー）は、**最大3回**のリトライ（指数関数的バックオフ推奨）を実施する。リトライ後も失敗した場合は、データをローカルストレージ（SDカード）に保持し、次回の送信タイミングでまとめて送信する（**ストア＆フォワード**）。 | データロスの防止策。保持期間には上限（例：24時間）を設定。 |

---
## 4. 要件 F3: 通知（データ取得・送信の完了通知） 📢

| No. | 仕様項目 | 詳細 | 備考 |
| :--- | :--- | :--- | :--- |
| **F3-1** | **通知トリガー** | **Cloudflare Workers側でデータを受信し、保存処理が完了した**タイミングで実行する。 | ラズパイからの送信成功ではなく、データ保存の成功をもって通知とする。 |
| **F3-2** | **通知先** | **Slackの専用チャンネル**に通知する。 | Webhook URLはWorkersの設定で管理する。 |
| **F3-3** | **通知内容** | **データ取得が正常に完了したこと**を通知する。通知メッセージには、以下の主要情報を必須で含める。 | 運用開始初期段階でのシステム稼働確認に利用。 |
| | | - **`device_id`** (どのデバイスからのデータか) | |
| | | - **`timestamp_utc`** (取得時刻) | |
| | | - **最新の土壌水分量** (`soil_moisture`) | |
| **F3-4** | **エラー通知** | データ取得・送信に**重大なエラー**が発生した場合（例: F2-6でリトライ後も失敗した場合、またはWorkers側でデータ保存に失敗した場合）は、**緊急性の高いメッセージ**で通知を行う。 | 異常時には担当者の**迅速な対応**を促す。 |
| **F3-5** | **通知頻度** | 取得したデータは、1時間に1回平均のデータを通知する。 |

---
## 5. 運用・保守仕様

| No. | 仕様項目 | 詳細 | 備考 |
| :--- | :--- | :--- | :--- |
| **M-1** | **設定管理** | センサーの校正値、取得・送信間隔、CloudflareのエンドポイントURL、APIトークンなどは、ラズパイのファイルシステム（例：`/etc/mimamori/config.json`）で一元管理する。 | リモートからの設定変更機能はフェーズ2で検討。 |
| **M-2** | **ロギング** | データ取得、前処理、送信の各ステップで成功・失敗を記録する。送信エラー時の詳細情報（HTTPステータスコードなど）も記録する。 | トラブルシューティングに不可欠。 |
| **M-3** | **電源管理** | 可能な限り低消費電力で動作するように設計する。バッテリー残量監視機能はオプションとして検討する。 | 特にソーラーパネルやバッテリー駆動のケースで重要。 |
| **M-4** | **可視化ダッシュボード** | **Grafana**を用いて、収集した全データの推移を時系列グラフで表示するダッシュボードを構築する。**異常値の可視化**および**アラート設定**（オプション）を可能とする。 | データソースへの接続設定（認証情報など）はセキュアに管理する。 |
